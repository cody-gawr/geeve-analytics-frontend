import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { from as observableFrom, ReplaySubject } from 'rxjs';
import { filter, map, publishLast, refCount, take } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { STRIPE_OPTIONS, STRIPE_PUBLISHABLE_KEY } from '../interfaces/stripe';
import { isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { LazyStripeAPILoader } from './api-loader.service';
import { PlatformService } from './platform.service';
import { WindowRef } from './window-ref.service';
var StripeService = /** @class */ (function () {
    function StripeService(key, options, loader, window, _platform) {
        this.key = key;
        this.options = options;
        this.loader = loader;
        this.window = window;
        this._platform = _platform;
        this.stripeChanged$ = new ReplaySubject();
        this.stripe = {};
        this.changeKey(this.key, this.options)
            .pipe(take(1))
            .subscribe(function () { });
    }
    StripeService.prototype.changeKey = function (key, options) {
        var _this = this;
        var obs = this.loader.asStream().pipe(filter(function (status) { return status.loaded === true; }), map(function () {
            if (!_this.window.getNativeWindow()) {
                return;
            }
            var Stripe = _this.window.getNativeWindow().Stripe;
            if (key) {
                _this.stripe = options
                    ? Stripe(key, options)
                    : Stripe(key);
                _this.stripeChanged$.next(_this.stripe);
            }
            return _this.stripe;
        }), publishLast(), refCount());
        obs.subscribe();
        return obs;
    };
    StripeService.prototype.elements = function (options) {
        var _this = this;
        return this.stripeChanged$.pipe(map(function () { return _this.stripe.elements(options); }));
    };
    StripeService.prototype.createToken = function (a, b) {
        if (isBankAccount(a) && isBankAccountData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else if (isPii(a) && isPiiData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else {
            return observableFrom(this.stripe.createToken(a, b));
        }
    };
    StripeService.prototype.handleCardSetup = function (clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardSetup(clientSecret, element, cardSetupOptions));
    };
    StripeService.prototype.createSource = function (a, b) {
        if (isSourceData(a)) {
            return observableFrom(this.stripe.createSource(a));
        }
        return observableFrom(this.stripe.createSource(a, b));
    };
    StripeService.prototype.retrieveSource = function (source) {
        return observableFrom(this.stripe.retrieveSource(source));
    };
    StripeService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Inject(STRIPE_PUBLISHABLE_KEY)),
        tslib_1.__param(1, Inject(STRIPE_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [String, Object, LazyStripeAPILoader,
            WindowRef,
            PlatformService])
    ], StripeService);
    return StripeService;
}());
export { StripeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abm9tYWRyZXNlcnZhdGlvbnMvbmd4LXN0cmlwZS9wcm9qZWN0cy9uZ3gtc3RyaXBlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsSUFBSSxJQUFJLGNBQWMsRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDekUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUcxRSxPQUFPLEVBQUUsWUFBWSxFQUEwQyxNQUFNLHVCQUF1QixDQUFDO0FBQzdGLE9BQU8sRUFBcUIsY0FBYyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDakcsT0FBTyxFQUlMLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsS0FBSyxFQUNMLFNBQVMsRUFLVixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxtQkFBbUIsRUFBVSxNQUFNLHNCQUFzQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHakQ7SUFJRSx1QkFDMEMsR0FBVyxFQUNuQixPQUFnQixFQUN4QyxNQUEyQixFQUMzQixNQUFpQixFQUNqQixTQUEwQjtRQUpNLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDbkIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUN4QyxXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBUjdCLG1CQUFjLEdBQTRC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ZSxDQUFDLENBQUMsQ0FBQztTQUNsRTtRQUNELE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFFTSxzQ0FBYyxHQUFyQixVQUFzQixNQUFvQjtRQUN4QyxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFuRlUsYUFBYTtRQUR6QixVQUFVLEVBQUU7UUFNUixtQkFBQSxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtRQUM5QixtQkFBQSxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUE7aUVBQ1AsbUJBQW1CO1lBQ25CLFNBQVM7WUFDTixlQUFlO09BVHpCLGFBQWEsQ0FvRnpCO0lBQUQsb0JBQUM7Q0FBQSxBQXBGRCxJQW9GQztTQXBGWSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tIGFzIG9ic2VydmFibGVGcm9tLCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgcHVibGlzaExhc3QsIHJlZkNvdW50LCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRWxlbWVudCB9IGZyb20gJy4uL2ludGVyZmFjZXMvZWxlbWVudCc7XG5pbXBvcnQgeyBFbGVtZW50cywgRWxlbWVudHNPcHRpb25zIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50cyc7XG5pbXBvcnQgeyBpc1NvdXJjZURhdGEsIFNvdXJjZURhdGEsIFNvdXJjZVBhcmFtcywgU291cmNlUmVzdWx0IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zb3VyY2VzJztcbmltcG9ydCB7IE9wdGlvbnMsIFN0cmlwZUpTLCBTVFJJUEVfT1BUSU9OUywgU1RSSVBFX1BVQkxJU0hBQkxFX0tFWSB9IGZyb20gJy4uL2ludGVyZmFjZXMvc3RyaXBlJztcbmltcG9ydCB7XG4gIEJhbmtBY2NvdW50LFxuICBCYW5rQWNjb3VudERhdGEsXG4gIENhcmREYXRhT3B0aW9ucyxcbiAgaXNCYW5rQWNjb3VudCxcbiAgaXNCYW5rQWNjb3VudERhdGEsXG4gIGlzUGlpLFxuICBpc1BpaURhdGEsXG4gIFBpaSxcbiAgUGlpRGF0YSwgU2V0dXBJbnRlbnREYXRhLFxuICBTZXR1cEludGVudFJlc3VsdCxcbiAgVG9rZW5SZXN1bHRcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy90b2tlbic7XG5pbXBvcnQgeyBMYXp5U3RyaXBlQVBJTG9hZGVyLCBTdGF0dXMgfSBmcm9tICcuL2FwaS1sb2FkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBQbGF0Zm9ybVNlcnZpY2UgfSBmcm9tICcuL3BsYXRmb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2luZG93UmVmIH0gZnJvbSAnLi93aW5kb3ctcmVmLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3RyaXBlU2VydmljZSB7XG4gIHB1YmxpYyBzdHJpcGVDaGFuZ2VkJDogUmVwbGF5U3ViamVjdDxTdHJpcGVKUz4gPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xuICBwcml2YXRlIHN0cmlwZTogU3RyaXBlSlMgPSB7fSBhcyBTdHJpcGVKUztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KFNUUklQRV9QVUJMSVNIQUJMRV9LRVkpIHByaXZhdGUga2V5OiBzdHJpbmcsXG4gICAgQEluamVjdChTVFJJUEVfT1BUSU9OUykgcHJpdmF0ZSBvcHRpb25zOiBPcHRpb25zLFxuICAgIHByaXZhdGUgbG9hZGVyOiBMYXp5U3RyaXBlQVBJTG9hZGVyLFxuICAgIHByaXZhdGUgd2luZG93OiBXaW5kb3dSZWYsXG4gICAgcHJpdmF0ZSBfcGxhdGZvcm06IFBsYXRmb3JtU2VydmljZVxuICApIHtcbiAgICB0aGlzLmNoYW5nZUtleSh0aGlzLmtleSwgdGhpcy5vcHRpb25zKVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge30pO1xuICB9XG5cbiAgcHVibGljIGNoYW5nZUtleShcbiAgICBrZXk6IHN0cmluZyxcbiAgICBvcHRpb25zPzogT3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPFN0cmlwZUpTIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgb2JzID0gdGhpcy5sb2FkZXIuYXNTdHJlYW0oKS5waXBlKFxuICAgICAgZmlsdGVyKChzdGF0dXM6IFN0YXR1cykgPT4gc3RhdHVzLmxvYWRlZCA9PT0gdHJ1ZSksXG4gICAgICBtYXAoKCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMud2luZG93LmdldE5hdGl2ZVdpbmRvdygpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IFN0cmlwZSA9ICh0aGlzLndpbmRvdy5nZXROYXRpdmVXaW5kb3coKSBhcyBhbnkpLlN0cmlwZTtcbiAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgIHRoaXMuc3RyaXBlID0gb3B0aW9uc1xuICAgICAgICAgICAgPyAoU3RyaXBlKGtleSwgb3B0aW9ucykgYXMgU3RyaXBlSlMpXG4gICAgICAgICAgICA6IChTdHJpcGUoa2V5KSBhcyBTdHJpcGVKUyk7XG4gICAgICAgICAgdGhpcy5zdHJpcGVDaGFuZ2VkJC5uZXh0KHRoaXMuc3RyaXBlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdHJpcGU7XG4gICAgICB9KSxcbiAgICAgIHB1Ymxpc2hMYXN0KCksXG4gICAgICByZWZDb3VudCgpXG4gICAgKTtcbiAgICBvYnMuc3Vic2NyaWJlKCk7XG4gICAgcmV0dXJuIG9icztcbiAgfVxuXG4gIHB1YmxpYyBlbGVtZW50cyhvcHRpb25zPzogRWxlbWVudHNPcHRpb25zKTogT2JzZXJ2YWJsZTxFbGVtZW50cz4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZUNoYW5nZWQkLnBpcGUobWFwKCgpID0+IHRoaXMuc3RyaXBlLmVsZW1lbnRzKG9wdGlvbnMpKSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVG9rZW4oXG4gICAgYTogRWxlbWVudCB8IEJhbmtBY2NvdW50IHwgUGlpLFxuICAgIGI6IENhcmREYXRhT3B0aW9ucyB8IEJhbmtBY2NvdW50RGF0YSB8IFBpaURhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxUb2tlblJlc3VsdD4ge1xuICAgIGlmIChpc0JhbmtBY2NvdW50KGEpICYmIGlzQmFua0FjY291bnREYXRhKGIpKSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlVG9rZW4oYSwgYikpO1xuICAgIH0gZWxzZSBpZiAoaXNQaWkoYSkgJiYgaXNQaWlEYXRhKGIpKSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlVG9rZW4oYSwgYikpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20oXG4gICAgICAgIHRoaXMuc3RyaXBlLmNyZWF0ZVRva2VuKGEgYXMgRWxlbWVudCwgYiBhcyBDYXJkRGF0YU9wdGlvbnMgfCB1bmRlZmluZWQpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkU2V0dXAoXG4gICAgY2xpZW50U2VjcmV0OiBzdHJpbmcsXG4gICAgZWxlbWVudDogRWxlbWVudCxcbiAgICBjYXJkU2V0dXBPcHRpb25zPzogU2V0dXBJbnRlbnREYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U2V0dXBJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20oXG4gICAgICB0aGlzLnN0cmlwZS5oYW5kbGVDYXJkU2V0dXAoY2xpZW50U2VjcmV0LCBlbGVtZW50LCBjYXJkU2V0dXBPcHRpb25zKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlU291cmNlKFxuICAgIGE6IEVsZW1lbnQgfCBTb3VyY2VEYXRhLFxuICAgIGI/OiBTb3VyY2VEYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U291cmNlUmVzdWx0PiB7XG4gICAgaWYgKGlzU291cmNlRGF0YShhKSkge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVNvdXJjZShhIGFzIFNvdXJjZURhdGEpKTtcbiAgICB9XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVNvdXJjZShhIGFzIEVsZW1lbnQsIGIpKTtcbiAgfVxuXG4gIHB1YmxpYyByZXRyaWV2ZVNvdXJjZShzb3VyY2U6IFNvdXJjZVBhcmFtcyk6IE9ic2VydmFibGU8U291cmNlUmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLnJldHJpZXZlU291cmNlKHNvdXJjZSkpO1xuICB9XG59XG4iXX0=