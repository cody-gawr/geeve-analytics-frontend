import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { from as observableFrom, ReplaySubject } from 'rxjs';
import { filter, map, publishLast, refCount, take } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { STRIPE_OPTIONS, STRIPE_PUBLISHABLE_KEY } from '../interfaces/stripe';
import { isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { LazyStripeAPILoader } from './api-loader.service';
import { PlatformService } from './platform.service';
import { WindowRef } from './window-ref.service';
var StripeService = /** @class */ (function () {
    function StripeService(key, options, loader, window, _platform) {
        this.key = key;
        this.options = options;
        this.loader = loader;
        this.window = window;
        this._platform = _platform;
        this.stripeChanged$ = new ReplaySubject();
        this.stripe = {};
        this.changeKey(this.key, this.options)
            .pipe(take(1))
            .subscribe(function () { });
    }
    StripeService.prototype.changeKey = function (key, options) {
        var _this = this;
        var obs = this.loader.asStream().pipe(filter(function (status) { return status.loaded === true; }), map(function () {
            if (!_this.window.getNativeWindow()) {
                return;
            }
            var Stripe = _this.window.getNativeWindow().Stripe;
            if (key) {
                _this.stripe = options
                    ? Stripe(key, options)
                    : Stripe(key);
                _this.stripeChanged$.next(_this.stripe);
            }
            return _this.stripe;
        }), publishLast(), refCount());
        obs.subscribe();
        return obs;
    };
    StripeService.prototype.elements = function (options) {
        var _this = this;
        return this.stripeChanged$.pipe(map(function () { return _this.stripe.elements(options); }));
    };
    StripeService.prototype.createToken = function (a, b) {
        if (isBankAccount(a) && isBankAccountData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else if (isPii(a) && isPiiData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else {
            return observableFrom(this.stripe.createToken(a, b));
        }
    };
    StripeService.prototype.handleCardSetup = function (clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardSetup(clientSecret, element, cardSetupOptions));
    };
    StripeService.prototype.createSource = function (a, b) {
        if (isSourceData(a)) {
            return observableFrom(this.stripe.createSource(a));
        }
        return observableFrom(this.stripe.createSource(a, b));
    };
    StripeService.prototype.retrieveSource = function (source) {
        return observableFrom(this.stripe.retrieveSource(source));
    };
    StripeService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Inject(STRIPE_PUBLISHABLE_KEY)),
        tslib_1.__param(1, Inject(STRIPE_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [String, Object, LazyStripeAPILoader,
            WindowRef,
            PlatformService])
    ], StripeService);
    return StripeService;
}());
export { StripeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abm9tYWRyZXNlcnZhdGlvbnMvbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zdHJpcGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLElBQUksSUFBSSxjQUFjLEVBQWMsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUUsT0FBTyxFQUFFLFlBQVksRUFBMEMsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RixPQUFPLEVBQXFCLGNBQWMsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pHLE9BQU8sRUFJTCxhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBS1YsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsbUJBQW1CLEVBQVUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2pEO0lBSUUsdUJBQzBDLEdBQVcsRUFDbkIsT0FBZ0IsRUFDeEMsTUFBMkIsRUFDM0IsTUFBaUIsRUFDakIsU0FBMEI7UUFKTSxRQUFHLEdBQUgsR0FBRyxDQUFRO1FBQ25CLFlBQU8sR0FBUCxPQUFPLENBQVM7UUFDeEMsV0FBTSxHQUFOLE1BQU0sQ0FBcUI7UUFDM0IsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNqQixjQUFTLEdBQVQsU0FBUyxDQUFpQjtRQVI3QixtQkFBYyxHQUE0QixJQUFJLGFBQWEsRUFBRSxDQUFD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bEU7UUFDRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRU0sc0NBQWMsR0FBckIsVUFBc0IsTUFBb0I7UUFDeEMsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBbkZVLGFBQWE7UUFEekIsVUFBVSxFQUFFO1FBTVIsbUJBQUEsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUE7UUFDOUIsbUJBQUEsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFBO2lFQUNQLG1CQUFtQjtZQUNuQixTQUFTO1lBQ04sZUFBZTtPQVR6QixhQUFhLENBb0Z6QjtJQUFELG9CQUFDO0NBQUEsQUFwRkQsSUFvRkM7U0FwRlksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbSBhcyBvYnNlcnZhYmxlRnJvbSwgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHB1Ymxpc2hMYXN0LCByZWZDb3VudCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEVsZW1lbnQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2VsZW1lbnQnO1xuaW1wb3J0IHsgRWxlbWVudHMsIEVsZW1lbnRzT3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvZWxlbWVudHMnO1xuaW1wb3J0IHsgaXNTb3VyY2VEYXRhLCBTb3VyY2VEYXRhLCBTb3VyY2VQYXJhbXMsIFNvdXJjZVJlc3VsdCB9IGZyb20gJy4uL2ludGVyZmFjZXMvc291cmNlcyc7XG5pbXBvcnQgeyBPcHRpb25zLCBTdHJpcGVKUywgU1RSSVBFX09QVElPTlMsIFNUUklQRV9QVUJMSVNIQUJMRV9LRVkgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0cmlwZSc7XG5pbXBvcnQge1xuICBCYW5rQWNjb3VudCxcbiAgQmFua0FjY291bnREYXRhLFxuICBDYXJkRGF0YU9wdGlvbnMsXG4gIGlzQmFua0FjY291bnQsXG4gIGlzQmFua0FjY291bnREYXRhLFxuICBpc1BpaSxcbiAgaXNQaWlEYXRhLFxuICBQaWksXG4gIFBpaURhdGEsIFNldHVwSW50ZW50RGF0YSxcbiAgU2V0dXBJbnRlbnRSZXN1bHQsXG4gIFRva2VuUmVzdWx0XG59IGZyb20gJy4uL2ludGVyZmFjZXMvdG9rZW4nO1xuaW1wb3J0IHsgTGF6eVN0cmlwZUFQSUxvYWRlciwgU3RhdHVzIH0gZnJvbSAnLi9hcGktbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGxhdGZvcm1TZXJ2aWNlIH0gZnJvbSAnLi9wbGF0Zm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IFdpbmRvd1JlZiB9IGZyb20gJy4vd2luZG93LXJlZi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFN0cmlwZVNlcnZpY2Uge1xuICBwdWJsaWMgc3RyaXBlQ2hhbmdlZCQ6IFJlcGxheVN1YmplY3Q8U3RyaXBlSlM+ID0gbmV3IFJlcGxheVN1YmplY3QoKTtcbiAgcHJpdmF0ZSBzdHJpcGU6IFN0cmlwZUpTID0ge30gYXMgU3RyaXBlSlM7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChTVFJJUEVfUFVCTElTSEFCTEVfS0VZKSBwcml2YXRlIGtleTogc3RyaW5nLFxuICAgIEBJbmplY3QoU1RSSVBFX09QVElPTlMpIHByaXZhdGUgb3B0aW9uczogT3B0aW9ucyxcbiAgICBwcml2YXRlIGxvYWRlcjogTGF6eVN0cmlwZUFQSUxvYWRlcixcbiAgICBwcml2YXRlIHdpbmRvdzogV2luZG93UmVmLFxuICAgIHByaXZhdGUgX3BsYXRmb3JtOiBQbGF0Zm9ybVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5jaGFuZ2VLZXkodGhpcy5rZXksIHRoaXMub3B0aW9ucylcbiAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHt9KTtcbiAgfVxuXG4gIHB1YmxpYyBjaGFuZ2VLZXkoXG4gICAga2V5OiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IE9wdGlvbnNcbiAgKTogT2JzZXJ2YWJsZTxTdHJpcGVKUyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IG9icyA9IHRoaXMubG9hZGVyLmFzU3RyZWFtKCkucGlwZShcbiAgICAgIGZpbHRlcigoc3RhdHVzOiBTdGF0dXMpID0+IHN0YXR1cy5sb2FkZWQgPT09IHRydWUpLFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLndpbmRvdy5nZXROYXRpdmVXaW5kb3coKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBTdHJpcGUgPSAodGhpcy53aW5kb3cuZ2V0TmF0aXZlV2luZG93KCkgYXMgYW55KS5TdHJpcGU7XG4gICAgICAgIGlmIChrZXkpIHtcbiAgICAgICAgICB0aGlzLnN0cmlwZSA9IG9wdGlvbnNcbiAgICAgICAgICAgID8gKFN0cmlwZShrZXksIG9wdGlvbnMpIGFzIFN0cmlwZUpTKVxuICAgICAgICAgICAgOiAoU3RyaXBlKGtleSkgYXMgU3RyaXBlSlMpO1xuICAgICAgICAgIHRoaXMuc3RyaXBlQ2hhbmdlZCQubmV4dCh0aGlzLnN0cmlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3RyaXBlO1xuICAgICAgfSksXG4gICAgICBwdWJsaXNoTGFzdCgpLFxuICAgICAgcmVmQ291bnQoKVxuICAgICk7XG4gICAgb2JzLnN1YnNjcmliZSgpO1xuICAgIHJldHVybiBvYnM7XG4gIH1cblxuICBwdWJsaWMgZWxlbWVudHMob3B0aW9ucz86IEVsZW1lbnRzT3B0aW9ucyk6IE9ic2VydmFibGU8RWxlbWVudHM+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGVDaGFuZ2VkJC5waXBlKG1hcCgoKSA9PiB0aGlzLnN0cmlwZS5lbGVtZW50cyhvcHRpb25zKSkpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRva2VuKFxuICAgIGE6IEVsZW1lbnQgfCBCYW5rQWNjb3VudCB8IFBpaSxcbiAgICBiOiBDYXJkRGF0YU9wdGlvbnMgfCBCYW5rQWNjb3VudERhdGEgfCBQaWlEYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8VG9rZW5SZXN1bHQ+IHtcbiAgICBpZiAoaXNCYW5rQWNjb3VudChhKSAmJiBpc0JhbmtBY2NvdW50RGF0YShiKSkge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICB9IGVsc2UgaWYgKGlzUGlpKGEpICYmIGlzUGlpRGF0YShiKSkge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKFxuICAgICAgICB0aGlzLnN0cmlwZS5jcmVhdGVUb2tlbihhIGFzIEVsZW1lbnQsIGIgYXMgQ2FyZERhdGFPcHRpb25zIHwgdW5kZWZpbmVkKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlQ2FyZFNldHVwKFxuICAgIGNsaWVudFNlY3JldDogc3RyaW5nLFxuICAgIGVsZW1lbnQ6IEVsZW1lbnQsXG4gICAgY2FyZFNldHVwT3B0aW9ucz86IFNldHVwSW50ZW50RGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFNldHVwSW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKFxuICAgICAgdGhpcy5zdHJpcGUuaGFuZGxlQ2FyZFNldHVwKGNsaWVudFNlY3JldCwgZWxlbWVudCwgY2FyZFNldHVwT3B0aW9ucylcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVNvdXJjZShcbiAgICBhOiBFbGVtZW50IHwgU291cmNlRGF0YSxcbiAgICBiPzogU291cmNlRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFNvdXJjZVJlc3VsdD4ge1xuICAgIGlmIChpc1NvdXJjZURhdGEoYSkpIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBTb3VyY2VEYXRhKSk7XG4gICAgfVxuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBFbGVtZW50LCBiKSk7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmVTb3VyY2Uoc291cmNlOiBTb3VyY2VQYXJhbXMpOiBPYnNlcnZhYmxlPFNvdXJjZVJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5yZXRyaWV2ZVNvdXJjZShzb3VyY2UpKTtcbiAgfVxufVxuIl19