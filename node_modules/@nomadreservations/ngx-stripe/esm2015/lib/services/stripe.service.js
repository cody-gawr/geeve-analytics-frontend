import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { from as observableFrom, ReplaySubject } from 'rxjs';
import { filter, map, publishLast, refCount, take } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { STRIPE_OPTIONS, STRIPE_PUBLISHABLE_KEY } from '../interfaces/stripe';
import { isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { LazyStripeAPILoader } from './api-loader.service';
import { PlatformService } from './platform.service';
import { WindowRef } from './window-ref.service';
let StripeService = class StripeService {
    constructor(key, options, loader, window, _platform) {
        this.key = key;
        this.options = options;
        this.loader = loader;
        this.window = window;
        this._platform = _platform;
        this.stripeChanged$ = new ReplaySubject();
        this.stripe = {};
        this.changeKey(this.key, this.options)
            .pipe(take(1))
            .subscribe(() => { });
    }
    changeKey(key, options) {
        const obs = this.loader.asStream().pipe(filter((status) => status.loaded === true), map(() => {
            if (!this.window.getNativeWindow()) {
                return;
            }
            const Stripe = this.window.getNativeWindow().Stripe;
            if (key) {
                this.stripe = options
                    ? Stripe(key, options)
                    : Stripe(key);
                this.stripeChanged$.next(this.stripe);
            }
            return this.stripe;
        }), publishLast(), refCount());
        obs.subscribe();
        return obs;
    }
    elements(options) {
        return this.stripeChanged$.pipe(map(() => this.stripe.elements(options)));
    }
    createToken(a, b) {
        if (isBankAccount(a) && isBankAccountData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else if (isPii(a) && isPiiData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else {
            return observableFrom(this.stripe.createToken(a, b));
        }
    }
    handleCardSetup(clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardSetup(clientSecret, element, cardSetupOptions));
    }
    createSource(a, b) {
        if (isSourceData(a)) {
            return observableFrom(this.stripe.createSource(a));
        }
        return observableFrom(this.stripe.createSource(a, b));
    }
    retrieveSource(source) {
        return observableFrom(this.stripe.retrieveSource(source));
    }
};
StripeService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(0, Inject(STRIPE_PUBLISHABLE_KEY)),
    tslib_1.__param(1, Inject(STRIPE_OPTIONS)),
    tslib_1.__metadata("design:paramtypes", [String, Object, LazyStripeAPILoader,
        WindowRef,
        PlatformService])
], StripeService);
export { StripeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abm9tYWRyZXNlcnZhdGlvbnMvbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zdHJpcGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLElBQUksSUFBSSxjQUFjLEVBQWMsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUUsT0FBTyxFQUFFLFlBQVksRUFBMEMsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RixPQUFPLEVBQXFCLGNBQWMsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pHLE9BQU8sRUFJTCxhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBS1YsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsbUJBQW1CLEVBQVUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2pELElBQWEsYUFBYSxHQUExQixNQUFhLGFBQWE7SUFJeEIsWUFDMEMsR0FBVyxFQUNuQixPQUFnQixFQUN4QyxNQUEyQixFQUMzQixNQUFpQixFQUNqQixTQUEwQjtRQUpNLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDbkIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUN4QyxXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBUjdCLG1CQUFj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QUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRU0sY0FBYyxDQUFDLE1BQW9CO1FBQ3hDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztDQUNGLENBQUE7QUFwRlksYUFBYTtJQUR6QixVQUFVLEVBQUU7SUFNUixtQkFBQSxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtJQUM5QixtQkFBQSxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUE7NkRBQ1AsbUJBQW1CO1FBQ25CLFNBQVM7UUFDTixlQUFlO0dBVHpCLGFBQWEsQ0FvRnpCO1NBcEZZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb20gYXMgb2JzZXJ2YWJsZUZyb20sIE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBwdWJsaXNoTGFzdCwgcmVmQ291bnQsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBFbGVtZW50IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50JztcbmltcG9ydCB7IEVsZW1lbnRzLCBFbGVtZW50c09wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2VsZW1lbnRzJztcbmltcG9ydCB7IGlzU291cmNlRGF0YSwgU291cmNlRGF0YSwgU291cmNlUGFyYW1zLCBTb3VyY2VSZXN1bHQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3NvdXJjZXMnO1xuaW1wb3J0IHsgT3B0aW9ucywgU3RyaXBlSlMsIFNUUklQRV9PUFRJT05TLCBTVFJJUEVfUFVCTElTSEFCTEVfS0VZIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zdHJpcGUnO1xuaW1wb3J0IHtcbiAgQmFua0FjY291bnQsXG4gIEJhbmtBY2NvdW50RGF0YSxcbiAgQ2FyZERhdGFPcHRpb25zLFxuICBpc0JhbmtBY2NvdW50LFxuICBpc0JhbmtBY2NvdW50RGF0YSxcbiAgaXNQaWksXG4gIGlzUGlpRGF0YSxcbiAgUGlpLFxuICBQaWlEYXRhLCBTZXR1cEludGVudERhdGEsXG4gIFNldHVwSW50ZW50UmVzdWx0LFxuICBUb2tlblJlc3VsdFxufSBmcm9tICcuLi9pbnRlcmZhY2VzL3Rva2VuJztcbmltcG9ydCB7IExhenlTdHJpcGVBUElMb2FkZXIsIFN0YXR1cyB9IGZyb20gJy4vYXBpLWxvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IFBsYXRmb3JtU2VydmljZSB9IGZyb20gJy4vcGxhdGZvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBXaW5kb3dSZWYgfSBmcm9tICcuL3dpbmRvdy1yZWYuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdHJpcGVTZXJ2aWNlIHtcbiAgcHVibGljIHN0cmlwZUNoYW5nZWQkOiBSZXBsYXlTdWJqZWN0PFN0cmlwZUpTPiA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XG4gIHByaXZhdGUgc3RyaXBlOiBTdHJpcGVKUyA9IHt9IGFzIFN0cmlwZUpTO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoU1RSSVBFX1BVQkxJU0hBQkxFX0tFWSkgcHJpdmF0ZSBrZXk6IHN0cmluZyxcbiAgICBASW5qZWN0KFNUUklQRV9PUFRJT05TKSBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnMsXG4gICAgcHJpdmF0ZSBsb2FkZXI6IExhenlTdHJpcGVBUElMb2FkZXIsXG4gICAgcHJpdmF0ZSB3aW5kb3c6IFdpbmRvd1JlZixcbiAgICBwcml2YXRlIF9wbGF0Zm9ybTogUGxhdGZvcm1TZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuY2hhbmdlS2V5KHRoaXMua2V5LCB0aGlzLm9wdGlvbnMpXG4gICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7fSk7XG4gIH1cblxuICBwdWJsaWMgY2hhbmdlS2V5KFxuICAgIGtleTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBPcHRpb25zXG4gICk6IE9ic2VydmFibGU8U3RyaXBlSlMgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBvYnMgPSB0aGlzLmxvYWRlci5hc1N0cmVhbSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoKHN0YXR1czogU3RhdHVzKSA9PiBzdGF0dXMubG9hZGVkID09PSB0cnVlKSxcbiAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy53aW5kb3cuZ2V0TmF0aXZlV2luZG93KCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgU3RyaXBlID0gKHRoaXMud2luZG93LmdldE5hdGl2ZVdpbmRvdygpIGFzIGFueSkuU3RyaXBlO1xuICAgICAgICBpZiAoa2V5KSB7XG4gICAgICAgICAgdGhpcy5zdHJpcGUgPSBvcHRpb25zXG4gICAgICAgICAgICA/IChTdHJpcGUoa2V5LCBvcHRpb25zKSBhcyBTdHJpcGVKUylcbiAgICAgICAgICAgIDogKFN0cmlwZShrZXkpIGFzIFN0cmlwZUpTKTtcbiAgICAgICAgICB0aGlzLnN0cmlwZUNoYW5nZWQkLm5leHQodGhpcy5zdHJpcGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnN0cmlwZTtcbiAgICAgIH0pLFxuICAgICAgcHVibGlzaExhc3QoKSxcbiAgICAgIHJlZkNvdW50KClcbiAgICApO1xuICAgIG9icy5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gb2JzO1xuICB9XG5cbiAgcHVibGljIGVsZW1lbnRzKG9wdGlvbnM/OiBFbGVtZW50c09wdGlvbnMpOiBPYnNlcnZhYmxlPEVsZW1lbnRzPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlQ2hhbmdlZCQucGlwZShtYXAoKCkgPT4gdGhpcy5zdHJpcGUuZWxlbWVudHMob3B0aW9ucykpKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUb2tlbihcbiAgICBhOiBFbGVtZW50IHwgQmFua0FjY291bnQgfCBQaWksXG4gICAgYjogQ2FyZERhdGFPcHRpb25zIHwgQmFua0FjY291bnREYXRhIHwgUGlpRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFRva2VuUmVzdWx0PiB7XG4gICAgaWYgKGlzQmFua0FjY291bnQoYSkgJiYgaXNCYW5rQWNjb3VudERhdGEoYikpIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgfSBlbHNlIGlmIChpc1BpaShhKSAmJiBpc1BpaURhdGEoYikpIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbShcbiAgICAgICAgdGhpcy5zdHJpcGUuY3JlYXRlVG9rZW4oYSBhcyBFbGVtZW50LCBiIGFzIENhcmREYXRhT3B0aW9ucyB8IHVuZGVmaW5lZClcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhhbmRsZUNhcmRTZXR1cChcbiAgICBjbGllbnRTZWNyZXQ6IHN0cmluZyxcbiAgICBlbGVtZW50OiBFbGVtZW50LFxuICAgIGNhcmRTZXR1cE9wdGlvbnM/OiBTZXR1cEludGVudERhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxTZXR1cEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbShcbiAgICAgIHRoaXMuc3RyaXBlLmhhbmRsZUNhcmRTZXR1cChjbGllbnRTZWNyZXQsIGVsZW1lbnQsIGNhcmRTZXR1cE9wdGlvbnMpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVTb3VyY2UoXG4gICAgYTogRWxlbWVudCB8IFNvdXJjZURhdGEsXG4gICAgYj86IFNvdXJjZURhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICBpZiAoaXNTb3VyY2VEYXRhKGEpKSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlU291cmNlKGEgYXMgU291cmNlRGF0YSkpO1xuICAgIH1cbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlU291cmNlKGEgYXMgRWxlbWVudCwgYikpO1xuICB9XG5cbiAgcHVibGljIHJldHJpZXZlU291cmNlKHNvdXJjZTogU291cmNlUGFyYW1zKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUucmV0cmlldmVTb3VyY2Uoc291cmNlKSk7XG4gIH1cbn1cbiJdfQ==