import { BehaviorSubject, from } from 'rxjs';
import { filter, first, map, switchMap } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { isAccount, isAccountData, isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { isHandleCardPaymentOptions, isPaymentMethodData } from '../interfaces/payment-intent';
var StripeInstance = /** @class */ (function () {
    function StripeInstance(loader, window, key, options) {
        var _this = this;
        this.loader = loader;
        this.window = window;
        this.key = key;
        this.options = options;
        this.stripe$ = new BehaviorSubject(undefined);
        this.loader
            .asStream()
            .pipe(filter(function (status) { return status.loaded === true; }), first(), map(function () { return _this.window.getNativeWindow().Stripe; }))
            .subscribe(function (Stripe) {
            var stripe = _this.options
                ? Stripe(_this.key, _this.options)
                : Stripe(_this.key);
            _this.stripe$.next(stripe);
        });
    }
    StripeInstance.prototype.getInstance = function () {
        return this.stripe$.getValue();
    };
    StripeInstance.prototype.elements = function (options) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), map(function (stripe) { return stripe.elements(options); }), first());
    };
    StripeInstance.prototype.createToken = function (a, b) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            if (isAccount(a) && isAccountData(b)) {
                return from(stripe.createToken(a, b));
            }
            else if (isBankAccount(a) && isBankAccountData(b)) {
                return from(stripe.createToken(a, b));
            }
            else if (isPii(a) && isPiiData(b)) {
                return from(stripe.createToken(a, b));
            }
            else {
                return from(stripe.createToken(a, b));
            }
        }), first());
    };
    StripeInstance.prototype.createSource = function (a, b) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            if (isSourceData(a)) {
                return from(stripe.createSource(a));
            }
            return from(stripe.createSource(a, b));
        }), first());
    };
    StripeInstance.prototype.retrieveSource = function (source) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            return from(stripe.retrieveSource(source));
        }), first());
    };
    StripeInstance.prototype.paymentRequest = function (options) {
        var stripe = this.getInstance();
        if (stripe) {
            return stripe.paymentRequest(options);
        }
        return undefined;
    };
    StripeInstance.prototype.handleCardPayment = function (a, b, c) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            if (isHandleCardPaymentOptions(b)) {
                return from(stripe.handleCardPayment(a, b));
            }
            return from(stripe.handleCardPayment(a, b, c));
        }));
    };
    StripeInstance.prototype.handleCardAction = function (a) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            return from(stripe.handleCardAction(a));
        }));
    };
    StripeInstance.prototype.confirmPaymentIntent = function (a, b) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            return from(stripe.confirmPaymentIntent(a, b));
        }));
    };
    StripeInstance.prototype.createPaymentMethod = function (a, b, c) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            return from(stripe.createPaymentMethod(a, b, c));
        }), first());
    };
    StripeInstance.prototype.handleCardSetup = function (a, b, c) {
        return this.stripe$.asObservable().pipe(filter(function (stripe) { return Boolean(stripe); }), switchMap(function (s) {
            var stripe = s;
            if (isPaymentMethodData(c)) {
                return from(stripe.handleCardSetup(a, b, c));
            }
            return from(stripe.handleCardSetup(a, b));
        }));
    };
    return StripeInstance;
}());
export { StripeInstance };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLWluc3RhbmNlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zdHJpcGUtaW5zdGFuY2UuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBUS9ELE9BQU8sRUFHTCxZQUFZLEVBRWIsTUFBTSx1QkFBdUIsQ0FBQztBQUMvQixPQUFPLEVBU0wsU0FBUyxFQUNULGFBQWEsRUFDYixhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBQ1YsTUFBTSxxQkFBcUIsQ0FBQztBQUc3QixPQUFPLEVBTUwsMEJBQTBCLEVBQzFCLG1CQUFtQixFQUNwQixNQUFNLDhCQUE4QixDQUFDO0FBR3RDO0lBS0Usd0JBQ1MsTUFBMkIsRUFDM0IsTUFBaUIsRUFDakIsR0FBVyxFQUNYLE9BQWlCO1FBSjFCLGlCQW9CQztRQW5CUSxXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDWCxZQUFPLEdBQVAsT0FBTyxDQUFVO1FBUmxCLFlBQU8sR0FBMEMsSUFBSSxlQUFlLENBRTFFLFNBQVMsQ0FBQyxDQUFDO1FBUVgsSUFBSSxDQUFDLE1BQU07YUFDUixRQUFRLEVBQUU7YUFDVixJQUFJLENBQ0gsTUFBTSxDQUFDLFVBQUMsTUFBYyxJQUFLLE9BQUEsTUFBTSxDQUFDLE1BQU0sS0FBSyxJQUFJLEVBQXRCLENBQXNCLENBQUMsRUFDbEQsS0FBSyxFQUFFLEVBQ1AsR0FBRyxDQUFDLGNBQU0sT0FBQyxLQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBVSxDQUFDLE1BQU0s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ZixDQUFlLENBQUMsRUFDakMsU0FBUyxDQUFDLFVBQUEsQ0FBQztZQUNULElBQU0sTUFBTSxHQUFHLENBQWEsQ0FBQztZQUU3QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxFQUNGLEtBQUssRUFBRSxDQUNSLENBQUM7SUFDSixDQUFDO0lBRU0sd0NBQWUsR0FBdEIsVUFDRSxDQUFTLEVBQ1QsQ0FBd0MsRUFDeEMsQ0FBcUI7UUFFckIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDckMsTUFBTSxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFmLENBQWUsQ0FBQyxFQUNqQyxTQUFTLENBQUMsVUFBQSxDQUFDO1lBQ1QsSUFBTSxNQUFNLEdBQUcsQ0FBYSxDQUFDO1lBRTdCLElBQUksbUJBQW1CLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQzFCLE9BQU8sSUFBSSxDQUNULE1BQU0sQ0FBQyxlQUFlLENBQ3BCLENBQUMsRUFDRCxDQUFZLEVBQ1osQ0FBa0MsQ0FDbkMsQ0FDRixDQUFDO2FBQ0g7WUFFRCxPQUFPLElBQUksQ0FDVCxNQUFNLENBQUMsZUFBZSxDQUNwQixDQUFDLEVBQ0QsQ0FBMkMsQ0FDNUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFDSCxxQkFBQztBQUFELENBQUMsQUE1TUQsSUE0TUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGZyb20sIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgZmlyc3QsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBXaW5kb3dSZWYgfSBmcm9tICcuL3dpbmRvdy1yZWYuc2VydmljZSc7XG5pbXBvcnQgeyBMYXp5U3RyaXBlQVBJTG9hZGVyLCBTdGF0dXMgfSBmcm9tICcuL2FwaS1sb2FkZXIuc2VydmljZSc7XG5cbmltcG9ydCB7IFN0cmlwZUpTLCBPcHRpb25zIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zdHJpcGUnO1xuaW1wb3J0IHsgRWxlbWVudCB9IGZyb20gJy4uL2ludGVyZmFjZXMvZWxlbWVudCc7XG5pbXBvcnQgeyBFbGVtZW50cywgRWxlbWVudHNPcHRpb25zIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50cyc7XG5pbXBvcnQge1xuICBTb3VyY2VEYXRhLFxuICBTb3VyY2VSZXN1bHQsXG4gIGlzU291cmNlRGF0YSxcbiAgU291cmNlUGFyYW1zXG59IGZyb20gJy4uL2ludGVyZmFjZXMvc291cmNlcyc7XG5pbXBvcnQge1xuICBDYXJkRGF0YU9wdGlvbnMsXG4gIFRva2VuUmVzdWx0LFxuICBBY2NvdW50LFxuICBBY2NvdW50RGF0YSxcbiAgQmFua0FjY291bnQsXG4gIEJhbmtBY2NvdW50RGF0YSxcbiAgUGlpRGF0YSxcbiAgUGlpLFxuICBpc0FjY291bnQsXG4gIGlzQWNjb3VudERhdGEsXG4gIGlzQmFua0FjY291bnQsXG4gIGlzQmFua0FjY291bnREYXRhLFxuICBpc1BpaSxcbiAgaXNQaWlEYXRhXG59IGZyb20gJy4uL2ludGVyZmFjZXMvdG9rZW4nO1xuaW1wb3J0IHsgU3RyaXBlU2VydmljZUludGVyZmFjZSB9IGZyb20gJy4vc3RyaXBlLWluc3RhbmNlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQYXltZW50UmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3BheW1lbnQtcmVxdWVzdCc7XG5pbXBvcnQge1xuICBIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMsXG4gIFBheW1lbnRJbnRlbnRSZXN1bHQsXG4gIENvbmZpcm1QYXltZW50SW50ZW50T3B0aW9ucyxcbiAgUGF5bWVudE1ldGhvZERhdGEsXG4gIFBheW1lbnRNZXRob2RSZXN1bHQsXG4gIGlzSGFuZGxlQ2FyZFBheW1lbnRPcHRpb25zLFxuICBpc1BheW1lbnRNZXRob2REYXRhXG59IGZyb20gJy4uL2ludGVyZmFjZXMvcGF5bWVudC1pbnRlbnQnO1xuaW1wb3J0IHsgQ2FyZFNldHVwUmVzdWx0IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jYXJkLXNldHVwJztcblxuZXhwb3J0IGNsYXNzIFN0cmlwZUluc3RhbmNlIGltcGxlbWVudHMgU3RyaXBlU2VydmljZUludGVyZmFjZSB7XG4gIHByaXZhdGUgc3RyaXBlJDogQmVoYXZpb3JTdWJqZWN0PFN0cmlwZUpTIHwgdW5kZWZpbmVkPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8XG4gICAgU3RyaXBlSlMgfCB1bmRlZmluZWRcbiAgPih1bmRlZmluZWQpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBsb2FkZXI6IExhenlTdHJpcGVBUElMb2FkZXIsXG4gICAgcHVibGljIHdpbmRvdzogV2luZG93UmVmLFxuICAgIHB1YmxpYyBrZXk6IHN0cmluZyxcbiAgICBwdWJsaWMgb3B0aW9ucz86IE9wdGlvbnNcbiAgKSB7XG4gICAgdGhpcy5sb2FkZXJcbiAgICAgIC5hc1N0cmVhbSgpXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKChzdGF0dXM6IFN0YXR1cykgPT4gc3RhdHVzLmxvYWRlZCA9PT0gdHJ1ZSksXG4gICAgICAgIGZpcnN0KCksXG4gICAgICAgIG1hcCgoKSA9PiAodGhpcy53aW5kb3cuZ2V0TmF0aXZlV2luZG93KCkgYXMgYW55KS5TdHJpcGUpXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChTdHJpcGU6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBzdHJpcGUgPSB0aGlzLm9wdGlvbnNcbiAgICAgICAgICA/IChTdHJpcGUodGhpcy5rZXksIHRoaXMub3B0aW9ucykgYXMgU3RyaXBlSlMpXG4gICAgICAgICAgOiAoU3RyaXBlKHRoaXMua2V5KSBhcyBTdHJpcGVKUyk7XG5cbiAgICAgICAgdGhpcy5zdHJpcGUkLm5leHQoc3RyaXBlKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldEluc3RhbmNlKCk6IFN0cmlwZUpTIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmdldFZhbHVlKCk7XG4gIH1cblxuICBwdWJsaWMgZWxlbWVudHMob3B0aW9ucz86IEVsZW1lbnRzT3B0aW9ucyk6IE9ic2VydmFibGU8RWxlbWVudHM+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBtYXAoc3RyaXBlID0+IChzdHJpcGUgYXMgU3RyaXBlSlMpLmVsZW1lbnRzKG9wdGlvbnMpKSxcbiAgICAgIGZpcnN0KClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRva2VuKFxuICAgIGE6IEVsZW1lbnQgfCBBY2NvdW50IHwgQmFua0FjY291bnQgfCBQaWksXG4gICAgYjogQ2FyZERhdGFPcHRpb25zIHwgQWNjb3VudERhdGEgfCBCYW5rQWNjb3VudERhdGEgfCBQaWlEYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8VG9rZW5SZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgaWYgKGlzQWNjb3VudChhKSAmJiBpc0FjY291bnREYXRhKGIpKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc0JhbmtBY2NvdW50KGEpICYmIGlzQmFua0FjY291bnREYXRhKGIpKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1BpaShhKSAmJiBpc1BpaURhdGEoYikpIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShzdHJpcGUuY3JlYXRlVG9rZW4oYSwgYikpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgc3RyaXBlLmNyZWF0ZVRva2VuKGEgYXMgRWxlbWVudCwgYiBhcyBDYXJkRGF0YU9wdGlvbnMgfCB1bmRlZmluZWQpXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVTb3VyY2UoXG4gICAgYTogRWxlbWVudCB8IFNvdXJjZURhdGEsXG4gICAgYj86IFNvdXJjZURhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgaWYgKGlzU291cmNlRGF0YShhKSkge1xuICAgICAgICAgIHJldHVybiBmcm9tKHN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBTb3VyY2VEYXRhKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb20oc3RyaXBlLmNyZWF0ZVNvdXJjZShhIGFzIEVsZW1lbnQsIGIpKTtcbiAgICAgIH0pLFxuICAgICAgZmlyc3QoKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmVTb3VyY2Uoc291cmNlOiBTb3VyY2VQYXJhbXMpOiBPYnNlcnZhYmxlPFNvdXJjZVJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGZpbHRlcihzdHJpcGUgPT4gQm9vbGVhbihzdHJpcGUpKSxcbiAgICAgIHN3aXRjaE1hcChzID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gcyBhcyBTdHJpcGVKUztcblxuICAgICAgICByZXR1cm4gZnJvbShzdHJpcGUucmV0cmlldmVTb3VyY2Uoc291cmNlKSk7XG4gICAgICB9KSxcbiAgICAgIGZpcnN0KClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHBheW1lbnRSZXF1ZXN0KG9wdGlvbnM6IFBheW1lbnRSZXF1ZXN0T3B0aW9ucykge1xuICAgIGNvbnN0IHN0cmlwZSA9IHRoaXMuZ2V0SW5zdGFuY2UoKTtcbiAgICBpZiAoc3RyaXBlKSB7XG4gICAgICByZXR1cm4gc3RyaXBlLnBheW1lbnRSZXF1ZXN0KG9wdGlvbnMpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIGhhbmRsZUNhcmRQYXltZW50KFxuICAgIGE6IHN0cmluZyxcbiAgICBiOiBFbGVtZW50IHwgSGFuZGxlQ2FyZFBheW1lbnRPcHRpb25zLFxuICAgIGM/OiBIYW5kbGVDYXJkUGF5bWVudE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxQYXltZW50SW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgZmlsdGVyKHN0cmlwZSA9PiBCb29sZWFuKHN0cmlwZSkpLFxuICAgICAgc3dpdGNoTWFwKHMgPT4ge1xuICAgICAgICBjb25zdCBzdHJpcGUgPSBzIGFzIFN0cmlwZUpTO1xuXG4gICAgICAgIGlmIChpc0hhbmRsZUNhcmRQYXltZW50T3B0aW9ucyhiKSkge1xuICAgICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgc3RyaXBlLmhhbmRsZUNhcmRQYXltZW50KGEgYXMgc3RyaW5nLCBiIGFzIEhhbmRsZUNhcmRQYXltZW50T3B0aW9ucylcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgc3RyaXBlLmhhbmRsZUNhcmRQYXltZW50KFxuICAgICAgICAgICAgYSBhcyBzdHJpbmcsXG4gICAgICAgICAgICBiIGFzIEVsZW1lbnQsXG4gICAgICAgICAgICBjIGFzIEhhbmRsZUNhcmRQYXltZW50T3B0aW9ucyB8IHVuZGVmaW5lZFxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkQWN0aW9uKGE6IHN0cmluZyk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGZpbHRlcihzdHJpcGUgPT4gQm9vbGVhbihzdHJpcGUpKSxcbiAgICAgIHN3aXRjaE1hcChzID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gcyBhcyBTdHJpcGVKUztcblxuICAgICAgICByZXR1cm4gZnJvbShzdHJpcGUuaGFuZGxlQ2FyZEFjdGlvbihhIGFzIHN0cmluZykpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGNvbmZpcm1QYXltZW50SW50ZW50KFxuICAgIGE6IHN0cmluZyxcbiAgICBiPzogQ29uZmlybVBheW1lbnRJbnRlbnRPcHRpb25zXG4gICk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGZpbHRlcihzdHJpcGUgPT4gQm9vbGVhbihzdHJpcGUpKSxcbiAgICAgIHN3aXRjaE1hcChzID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gcyBhcyBTdHJpcGVKUztcblxuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICBzdHJpcGUuY29uZmlybVBheW1lbnRJbnRlbnQoXG4gICAgICAgICAgICBhIGFzIHN0cmluZyxcbiAgICAgICAgICAgIGIgYXMgQ29uZmlybVBheW1lbnRJbnRlbnRPcHRpb25zIHwgdW5kZWZpbmVkXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVBheW1lbnRNZXRob2QoXG4gICAgYTogc3RyaW5nLFxuICAgIGI6IEVsZW1lbnQsXG4gICAgYz86IFBheW1lbnRNZXRob2REYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8UGF5bWVudE1ldGhvZFJlc3VsdD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZSQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIGZpbHRlcihzdHJpcGUgPT4gQm9vbGVhbihzdHJpcGUpKSxcbiAgICAgIHN3aXRjaE1hcChzID0+IHtcbiAgICAgICAgY29uc3Qgc3RyaXBlID0gcyBhcyBTdHJpcGVKUztcblxuICAgICAgICByZXR1cm4gZnJvbShzdHJpcGUuY3JlYXRlUGF5bWVudE1ldGhvZChhLCBiLCBjKSk7XG4gICAgICB9KSxcbiAgICAgIGZpcnN0KClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGhhbmRsZUNhcmRTZXR1cChcbiAgICBhOiBzdHJpbmcsXG4gICAgYj86IEVsZW1lbnQgfCBzdHJpbmcgfCBQYXltZW50TWV0aG9kRGF0YSxcbiAgICBjPzogUGF5bWVudE1ldGhvZERhdGFcbiAgKTogT2JzZXJ2YWJsZTxDYXJkU2V0dXBSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGUkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoc3RyaXBlID0+IEJvb2xlYW4oc3RyaXBlKSksXG4gICAgICBzd2l0Y2hNYXAocyA9PiB7XG4gICAgICAgIGNvbnN0IHN0cmlwZSA9IHMgYXMgU3RyaXBlSlM7XG5cbiAgICAgICAgaWYgKGlzUGF5bWVudE1ldGhvZERhdGEoYykpIHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHN0cmlwZS5oYW5kbGVDYXJkU2V0dXAoXG4gICAgICAgICAgICAgIGEsXG4gICAgICAgICAgICAgIGIgYXMgRWxlbWVudCxcbiAgICAgICAgICAgICAgYyBhcyBQYXltZW50TWV0aG9kRGF0YSB8IHVuZGVmaW5lZFxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICBzdHJpcGUuaGFuZGxlQ2FyZFNldHVwKFxuICAgICAgICAgICAgYSxcbiAgICAgICAgICAgIGIgYXMgc3RyaW5nIHwgUGF5bWVudE1ldGhvZERhdGEgfCB1bmRlZmluZWRcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==